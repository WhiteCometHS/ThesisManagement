@using DiplomaManagement.Entities
@using DiplomaManagement.Interfaces
@using Microsoft.AspNetCore.Antiforgery
@model DiplomaManagement.Models.PromoterThesisViewModel

@inject INotificationService NotificationService
@inject IAntiforgery _antiforgery
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Details";
    var antiforgeryToken = _antiforgery.GetTokens(HttpContextAccessor.HttpContext).RequestToken;
    var comment = Model.Comment ?? string.Empty;
    var thesisSophistication = Model.ThesisSophistication ?? string.Empty;
}

@section Styles {
    <link rel="stylesheet" href="~/css/thesis.css" />
}

<h1>Details</h1>
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
<symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
  </symbol>
</svg>
<div id="liveAlertPlaceholder"></div>

<div>
    <h4>Thesis</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Title)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Title)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Description)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Description)
        </dd>
    </dl>

    @if (ViewBag.OriginalPdf != null || ViewBag.PresentationFile != null)
    {
        <div class="additional-materials text-center">
            <h2 class="mb-4">Files:</h2>
        </div>

        @if (ViewBag.OriginalPdf != null)
        {
            PdfFile pdf = ViewBag.OriginalPdf;
            <table class="table table-striped table-bordered">
                <tbody>
                    <tr>
                        <td width="60%">
                            @pdf.FileName
                        </td>
                        <td width="10%">
                            <div class="d-grid">
                                <a asp-action="DownloadDocument" asp-route-id="@pdf.Id" class="btn btn-primary">Download</a>
                            </div>
                        </td>
                        <td width="30%">
                            <div class="toggle-switch" data-file-id="@pdf.Id" id="pdf">
                                <button type="button" class="btn btn-outline-danger state-off @(pdf.FileStatus == FileStatus.NotAccepted ? "activated-state-off" : "")" data-status="@FileStatus.NotAccepted">Not accepted</button>
                                <button type="button" class="btn btn-outline-warning state-none @(pdf.FileStatus == FileStatus.NotVerified ? "activated-state-none" : "")" data-status="@FileStatus.NotVerified">Not verified</button>
                                <button type="button" class="btn btn-outline-success state-on @(pdf.FileStatus == FileStatus.Accepted ? "activated-state-on" : "")" data-status="@FileStatus.Accepted">Accepted</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        }

        @if (ViewBag.PresentationFile != null)
        {
            PresentationFile presentation = ViewBag.PresentationFile;
            <table class="table table-striped table-bordered">
                <tbody>
                    <tr>
                        <td width="60%">
                            @presentation.FileName
                        </td>
                        <td width="10%">
                            <div class="d-grid">
                                <a asp-action="DownloadPresentation" asp-route-id="@presentation.Id" class="btn btn-primary">Download</a>
                            </div>
                        </td>
                        <td width="30%">
                            <div class="toggle-switch" data-file-id="@presentation.Id" id="presentation">
                                <button type="button" class="btn btn-outline-danger state-off @(presentation.FileStatus == FileStatus.NotAccepted ? "activated-state-off" : "")" data-status="@FileStatus.NotAccepted">
                                    Not accepted
                                </button>
                                <button type="button" class="btn btn-outline-warning state-none @(presentation.FileStatus == FileStatus.NotVerified ? "activated-state-none" : "")" data-status="@FileStatus.NotVerified">
                                    Not verified
                                </button>
                                <button type="button" class="btn btn-outline-success state-on @(presentation.FileStatus == FileStatus.Accepted ? "activated-state-on" : "")" data-status="@FileStatus.Accepted">
                                    Accepted
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        }

        <div id="textarea-form" style="display:none;">
            <form id="conclusionForm" method="post" action="/Thesis/SetThesisConclusion">
                <div class="form-floating">
                    <textarea name="conclusion" class="form-control" rows="3" placeholder="Leave a comment here" id="floatingTextarea" style="height: 100px"></textarea>
                    <label for="floatingTextarea" id="textareaLabel"></label>
                </div>
                <input type="hidden" name="id" id="fileId" value="@Model.Id">
                <button type="submit" class="btn btn-primary mt-2">Submit</button>
            </form>
        </div>
    }
</div>
<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = '@antiforgeryToken';
            const comment = '@comment';
            const thesisSophistication = '@thesisSophistication';
            var conclusionAction;

            const alert = (message) => {
                const alertPlaceholder = document.getElementById('liveAlertPlaceholder');
                let existingAlert = document.getElementById('info-message');
                if (existingAlert) {
                    existingAlert.querySelector('div').innerHTML = message;
                } else {
                    const wrapper = document.createElement('div')
                    wrapper.innerHTML = [
                        `<div class="alert alert-success d-flex align-items-center alert-dismissible fade show" role="alert" id="info-message">`,
                        `   <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:"><use xlink:href="#check-circle-fill"/></svg>`,
                        `   <div>${message}</div>`,
                        '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                        '</div>'
                    ].join('')

                    alertPlaceholder.append(wrapper)

                    setTimeout(function () { 
                        var alert = new bootstrap.Alert(wrapper);
                        alert.close();
                    }, 5000);
                }
            }

            const toggleConclusionForm = () => {
                const toggleSwitchDivs = document.querySelectorAll('.toggle-switch');
                const dataStatusList = [];

                toggleSwitchDivs.forEach(toggleSwitch => {
                    const activatedElements = toggleSwitch.querySelectorAll('[class*="activated"]');

                    activatedElements.forEach(element => {
                        const dataStatus = element.getAttribute('data-status');
                        if (dataStatus) {
                            dataStatusList.push(dataStatus);
                        }
                    });
                });

                const containsNotAccepted = dataStatusList.includes("NotAccepted");
                if (containsNotAccepted) {
                    conclusionAction = '0';
                    //$('#conclusionForm').attr('action', '/Thesis/SetThesisConclusion');
                    $('#textareaLabel').text('Leave a comment here:');
                    $('#floatingTextarea').text(comment);
                    $('#textarea-form').show();
                } else {
                    const allAccepted = dataStatusList.every(status => status === "Accepted");
                    if (allAccepted) {
                        conclusionAction = '1';
                        //$('#conclusionForm').attr('action', '/Thesis/SetThesisSophistication');
                        $('#textareaLabel').text('Enter degree of advancement of the thesis:');
                        $('#floatingTextarea').text(thesisSophistication);
                        $('#textarea-form').show();
                    }
                    else {
                        $('#textarea-form').hide();
                    }
                }
            }

            toggleConclusionForm();

            document.querySelectorAll('.toggle-switch button').forEach(button => {
                button.addEventListener('click', function () {
                    const toggleSwitch = button.closest('.toggle-switch');
                    const fileId = toggleSwitch.getAttribute('data-file-id');
                    const status = button.getAttribute('data-status');
                    const url = '/Thesis/' + (toggleSwitch.id === 'pdf' ? 'UpdateDocumentStatus' : 'UpdatePresentationStatus');

                    $.ajax({
                        url: url,
                        method: 'POST',
                        data: {
                            __RequestVerificationToken: token,
                            id: fileId,
                            status: status
                        },
                        success: function () {
                            alert(`File status has been successfully changed to ${status}`);

                            const parentDiv = button.closest('.toggle-switch');
                            const buttons = parentDiv.querySelectorAll('button');

                            buttons.forEach(btn => {
                                btn.classList.remove('activated-state-off', 'activated-state-none', 'activated-state-on');
                            });

                            if (status === "NotAccepted") {
                                $(button).addClass("activated-state-off");
                            } else if (status === "NotVerified") {
                                $(button).addClass("activated-state-none");
                            } else if (status === "Accepted") {
                                $(button).addClass("activated-state-on");
                            }

                            toggleConclusionForm();
                        },
                        error: function () {
                            console.error("An error occurred while updating the file status.");
                        }
                    });
                });
            });

            $('#conclusionForm').on('submit', function (e) {
                e.preventDefault();
                var form = $(this);
                var actionUrl = form.attr('action');
                var formData = form.serializeArray();
                formData.push({ name: "__RequestVerificationToken", value: token });
                formData.push({ name: "conclusionType", value: conclusionAction });

                $.ajax({
                    url: actionUrl,
                    method: 'POST',
                    data: $.param(formData),
                    success: function (response) {
                        if (conclusionAction == 0) 
                            alert("Comments updated successfully.");               
                        else 
                            alert("Thesis sophistication updated successfully.");                        
                    },
                    error: function () {
                        console.error("An error occurred while submitting the comment.");
                    }
                });
            });
        });
    </script>
}
