@using DiplomaManagement.Entities
@using DiplomaManagement.Interfaces
@using Microsoft.AspNetCore.Antiforgery
@model DiplomaManagement.Models.PromoterThesisViewModel

@inject INotificationService NotificationService
@inject IAntiforgery _antiforgery
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Details";
    var antiforgeryToken = _antiforgery.GetTokens(HttpContextAccessor.HttpContext).RequestToken;
    var comment = Model.Comment ?? string.Empty;
    var thesisSophistication = Model.ThesisSophistication ?? string.Empty;

    var route = (ViewBag.PreviousRoute as string).Split('|');
    string previousController = route[0];
    string previousAction = route[1];
}

@section Styles {
    <link rel="stylesheet" href="~/css/thesis.css" />
}

<h1>Details</h1>
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
<symbol id="check-circle-fill" fill="currentColor" viewBox="0 0 16 16">
    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
  </symbol>
</svg>
<div id="liveAlertPlaceholder"></div>

<div>
    <h4>Thesis</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Title)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Title)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.Description)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.Description)
        </dd>
        <dt class="col-sm-2">
            Promoter
        </dt>
        <dd class="col-sm-10">
            @($"{Model.Promoter.User.FirstName} {Model.Promoter.User.LastName} ({Model.Promoter.User.Email})")
        </dd>
        @if(!string.IsNullOrEmpty(Model.Comment))
        {
            <dt class="col-sm-2">
                @Html.DisplayNameFor(model => model.Comment)
            </dt>
            <dd class="col-sm-10">
                @Html.DisplayFor(model => model.Comment)
            </dd>
        }
        @if(!string.IsNullOrEmpty(Model.ThesisSophistication))
        {
            <dt class="col-sm-2">
                @Html.DisplayNameFor(model => model.ThesisSophistication)
            </dt>
            <dd class="col-sm-10">
                @Html.DisplayFor(model => model.ThesisSophistication)
            </dd>
        }
    </dl>

    @if (Model.SystemFiles != null)
    {
        <div class="additional-materials text-center">
            <div class="mb-4">Additional materials:</div>
        </div>
        <table class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>Id</th>
                <th>File Name</th>
                <th>Extension</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var file in Model.SystemFiles)
            {
                <tr>
                    <th>
                        @file.Id
                    </th>
                    <th>
                        @file.FileName
                    </th>
                    <th>
                        @file.Extension
                    </th>
                    <td>
                        <a asp-action="Download" asp-route-id="@file.Id" class="btn btn-primary">Download</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    }
    else {
        <div class="additional-materials text-center">
            <div class="mb-4">Thesis don't have additional materials attached by promoter</div>
        </div>
    }

    @if (ViewBag.OriginalPdf != null || ViewBag.PresentationFile != null)
    {
        <div class="additional-materials text-center">
            <div class="mb-4">Uploaded files:</div>
        </div>

        @if (ViewBag.OriginalPdf != null)
        {
            PdfFile pdf = ViewBag.OriginalPdf;
            <table class="table table-striped table-bordered">
            <tbody>
                <tr>
                    <td width="80%">@pdf.FileName</td>
                    <td width="10%"><span class="fileStatus @pdf.FileStatus.ToString().ToLower()">@pdf.FileStatus</span></td>
                    <td width="10%">
                        <div class="d-grid">
                            <a asp-action="DownloadDocument" asp-route-id="@pdf.Id" class="btn btn-primary">Download</a>
                        </div>
                    </td>
                </tr>
            </tbody>
            </table>
        }

        @if (ViewBag.PresentationFile != null)
        {
            PresentationFile presentation = ViewBag.PresentationFile;
            <table class="table table-striped table-bordered">
                <tbody>
                    <tr>
                        <td width="80%">
                            @presentation.FileName
                        </td>
                        <td width="10%">
                            <span class="fileStatus @presentation.FileStatus.ToString().ToLower()">@presentation.FileStatus</span>
                        </td>
                        <td width="10%">
                            <div class="d-grid">
                                <a asp-action="DownloadPresentation" asp-route-id="@presentation.Id" class="btn btn-primary">Download</a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        }
    }
    else {
        <div class="additional-materials text-center">
            <div class="mb-4">Thesis don't have uploaded files</div>
        </div>
    }

    @if (Model.Enrollments != null && Model.Enrollments.Any()) 
    {
        <div class="additional-materials text-center">
            <div class="mb-4">Active enrollments:</div>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>
                        Nr.
                    </th>
                    <th>
                        Student
                    </th>
                    <th>
                        Email
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Enrollments)
                {
                    int counter = 1;
                    <tr>
                        <td>
                            @counter
                        </td>
                        <td>
                            @($"{item.Student.User.FirstName} {item.Student.User.LastName}")
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Student.User.Email)
                        </td>
                    </tr>
                    counter++;
                }
            </tbody>
        </table>
    }
</div>
<div>
    <a href="@Url.Action(previousAction, previousController)">Back to List</a>
</div>
